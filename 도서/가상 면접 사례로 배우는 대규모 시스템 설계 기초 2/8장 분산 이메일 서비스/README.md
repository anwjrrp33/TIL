# 8장 분산 이메일 서비스

## 1. 문제 이해 및 설계 범위 확정
```
Q1. 얼마나 많은 사람들이 사용하는 제품인가요?
→ 10억 명입니다.

Q2. 인증, 이메일 발송/수신, 모든 이메일 가져오기, 읽음 여부에 따른 이메일 필터링, 제목/발신인/메일 내용에 따른 검색 기능, 스팸 및 바이러스 방지기능이 중요할 것 같은데요.
→ 인증은 건너뛰고, 나머지 기능에 집중합시다.

Q3. 사용자는 메일 서버에 어떻게 연결하나요?
→ 전통적으로 SMTP, POP, IMAP 등의 프로토콜과 서비스 제공자 전용 프로토콜을 사용해 접속하지만 많이 사용하지만 구식이기 때문에 이번 면접에서는 HTTP를 사용합니다.

Q4. 첨부 파일도 지원해야 하나요?
→ 그렇습니다.
```

### 비기능 요구사항
* **안정성**: 이메일 데이터의 소실되어선 안된다.
* **가용성**: 이메일과 사용자 데이터를 여러 노드에 자동으로 복제하여 가용성 보장해야 하지만 장애가 발생해도 계속 동작해야 한다.
* **확장성**: 사용자 수가늘어도 감당할 수 있어야 하고, 사용자, 이메일 수가 늘어나도 시스템 성능 저하되지 않아야 한다.
* **유연성과 확장성**: 새 컴포넌트로 쉽게 기능 추가 및 성능 개선이 가능한 유연하고 확장성이 높은 시스템이여야 하고, 유연성과 호가장성을 갖추려면 맞춤형 프로토콜이 필요할수도 있다.

### 개력적인 규모 추정
* 10억 명의 사용자
* 1인 하루 송신 평균 이메일 수는 평균 10건이라고 가정, 이메일 전송 QPS = 10⁹ * 10 / 10⁵ = 100,000
* 1인 하루 수신 평균 이메일 수는 평균 40건, 이메일 하나의 메타데이터는 평균 50KB로 가정, 메타데이터에는 첨부 파일은 포함하지 않는다.
* 메타데이터는 DB에 저장한다고 가정, 1년간 메타데이터를 유지하기 위한 스토리지는 10억 * 40건 * 365일 * 50KB = 730PB
* 첨부 파일을 포함하는 이메일의 비율은 20%이고, 첨부 파일의 평균 크기는 500KB라고 가정
* 1년간 첨부파일을 보관하는데 필요한 저장 용량은 10억 * 40개 * 365일 * 20% * 500KB = 1,460PB

## 2. 개략적 설계안 제시 및 동의 구하기

### 이메일 101

#### 이메일 프로토콜
<table>
  <thead>
    <tr>
      <th>프로토콜</th>
      <th>설명</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>SMTP(Simple Mail Transfer Protocol)</td>
      <td>
        <li>이메일을 한 서버에서 다른 서버로 보내는 표준 프로토콜</li>
      </td>
    </tr>
    <tr>
      <td>POP</td>
      <td>
        <li>이메일 클라이언트가 원격 메일 서버에서 이메일을 수신하고 다운로드하기 위해 사용하는 표준 프로토콜</li>
        <li>단말로 다운된 이메일은 서버에서 삭제되서 한 대 단말에서만 이메일을 읽을 수 있다.</li>
        <li>이메일을 일부만 읽을 수 없어서 이메일 확인 시 전부 내려 받아야해서 용량이 큰 첨부 파일이 붙은 이메일은 읽으려면 시간이 </li>
      </td>
    </tr>
    <tr>
      <td>IMAP</td>
      <td>
        <li>이메일 클라이언트가 원격 메일 서버에서 이메일을 수신하는 데 사용되는 또 다른 표준 프로토콜</li>
        <li>여러 단말에서 이메일을 읽을 수 있다.</li>
        <li>개인 이메일 계정에서 가장 널리 사용되는 프로토콜로 이메일을 실제로 열기 전에는 헤더만 다운로드 하기 때문이에 인터넷 속도가 느려도 잘 동작한다.</li>
      </td>
    </tr>
    <tr>
      <td>HTTPS</td>
      <td>
        <li>기술적으로 메일 전송 프로토콜은 아니지만 웹 기반 이메일 시스템의 메일함 접속에 이용될 수 있다.</li>
      </td>
    </tr>
  </tbody>
</table>

#### 도메인 이름 서비스(DNS)
* 수신자 도메인의 메일 교환기 레코드 검색에 이용된다.
* 우선순위 값은 선호도로를 나타내고 우선순위가 높은 것부터 최우선으로 연결된다. 

![alt text](image.png)

#### 첨부 파일
* 일반적으로 Base64 인코딩을 사용한다.
* 크기 제한이 존재하고, 아웃룩과 지메일은 각각 20MB와 25MB로 제한했다.
* 다목적 인터넷 메일 확장은 인터넷을 통해 첨부 파일을 전송할 수 있도록 하는 표준 규격이다.

#### 전통적 메일 서버
* 보통 서버 한 대로 운영되는 사용자가 많지 않을 때 잘 동작하는 시스템이다.


> 전통적인 메일 서버 아키텍처 프로세스
1. 사용자A가 아웃룩 클라이언트에 로그인하여 이메일 작성 및 보내기 버튼을 클릭하면 아웃룩 메일 서버로 이메일 전송되며, 클라이언트와 메일 서버는 SMTP로 통신한다.
2. 아웃룩 메일 서버는 DNS 질의를 통해 수신자 SMTP 서버 주소(지메일)를 검색 후 해당 주소로 이메일을 전송되며, 메일 서버 간 SMTP로 통신한다.
3. 지메일 서버는 이메일 저장 후, 수신할 사용자B가 메일을 읽어갈 수 있도록 한다.
4. 사용자B가 지메일에 로그인하면 지메일 클라이언트는 IMAP/POP 서버를 통해 새 이메일을 가져온다.

![alt text](image-1.png)

> 저장소
* 이메일은 파일 시스템과 디렉터리에 저장된다.
  * 각 이메일은 고유한 이름을 가진 별도 파일로 보관
  * 각 사용자의 설정 데이터와 메일함은 사용자 디렉터리에 보관
* 주로 Maildir 이름의 디렉터리가 널리 사용된다.
* POP, IMAP, SMTP 같은 이메일 프로토콜은 오래 전에 발명되어 다양한 기능과 수십억 명의 사용자를 지원하도록 확장할 수 없었다.

### 분산 메일 서버
* 현대적 사용 패턴을 지원하고 확장성과 안정성 문제를 해결한다.

#### 이메일 API
* 메일 클라이언트, 이메일 생명주기 단계마다 달라질 수 있다.
  * 모바일 단말 클라이언트를 위한 SMTP/POP/IMAP API
  * 송신 측 메일 서버와 수신 측 메일 서버 간의 SMTP 통신
  * 대화형 웹 기반 이메일 애플리케이션을 위한 HTTP 기반 RESTful API

> 1. POST /v1/messages 엔드포인트
* To, Tc, Bcc 헤더에 명시된 수신자에게 메시지를 전송

> 2. GET /v1/folders 엔드포인트
* 주어진 이메일 계정에 존재하는 모든 폴더를 반환
```json
-- 응답 형식
[{
  id: string      고유한 폴더 식별자
  name: string    폴더 이름 (RFC6154에 따르면, 기본 폴더는 All, Archive, Drafts, Flagged, Junk, Sent, Trash 중 하나이다.)
  user_id: string 계정 소유자 ID
}]
```

> 3. GET /v1/folders/{:folder_id}/messages 엔드포인트
* 주어진 폴더 아래의 모든 메시지를 반환하지만 실제로는 pagenation을 지원하는 등 훨씬 복잡
```
-- 응답 형식
* 메시지 객체 목록
```

> 4. GET /v1/messages/{:message_id} 엔드포인트
* 주어진 특정 메시지에 대한 모든 정보를 반환하고 발신자, 수신자, 메시지 제목, 본문, 첨부 파일 등의 정보로 구성

```json
{
  user_id: string                      // 계정주의 ID
  from: name: string, email: string    // 발신자의 <이름, 이메일> 쌍
  to: [name: string, email: string]    // 수신자의 <이름, 이메일> 쌍의 **목록**
  subject: string                      // 이메일 제목
  body: string                         // 이메일 본문
  is_read: boolean                     // 수신자가 메시지를 읽었는지 여부
}
```

#### 분산 이메일 아키텍처
* 클라우드 기술을 활용하여 여러 메일 서버 간의 데이터 동기화 규모 확장 및 스팸 분류 등 까다로운 문제를 쉽게 풀어본다.

![alt text](image-2.png)

* **웹메일(webmail)**: