# 07 데이터 암호화
* 데이터 암호화 여부는 보안 감사에서 필수적으로 언급되는 부분이다.
* 핀테크 서비스처럼 중요한 정보를 저장하는 서비스에서는 응용 프로그램에서 암호화한 데이터를 데이터베이스 서버에서 다시 암호화하는 이중 암호화 방법을 선택하기도 한다.
* 응용 프로그램 암호화는 주로 중요 정보를 가진 칼럼 단위로 암호화를 수행하고 데이터베이스 수준에서는 테이블 단위로 암호화를 적용한다.

## 7.1 MySQL 서버의 데이터 암호화
* MySQL 서버의 암호화 기능은 데이터베이스 서보와 디스크 사이의 데이터 읽고 쓰기 지점에서 암호화 또는 복호화를 수행한다.
    * 그래서 MySQL 서버에서 디스크 입출력 이외의 부분에서는 암호화 처리가 전혀 필요치 않다.
    * 즉 MySQL 서버(InnoDB 스토리지 엔진)의 I/O 레이어에서만 데이터 암호화 및 복호화 과정이 실행되는 것이다.
    * MySQL 서버는 사용자의 쿼리를 처리하는 과정에서 테이블의 데이터가 암호화돼 있는지 여부를 식별할 필요가 없고, 암호화된 테이블 그냥 테이블과 동일한 처리 과정을 거친다.
    * 데이터 암호화 기능이 활성화 되있어도 MySQL 내부와 사용자 입장에서는 아무런 차이가 없다.
      * 이러한 암호화 방식을 이러한 암호화 방식을 TDE(Transparent Data Encryption) 또는 Data at Rest Encryption 이라고 한다.
        * Data at Rest는 메모리나 네트워크 전송 단계가 아닌 디스크에 저장된 단계에서만 암호화된다는 의미

<img src="./그림 7.1.png">

### 7.1.1 2단계 키 관리
* MySQL 서버의 TDE에서 암호화 키는 키링(KeyRing) 플러그인에 의해 관리된다.
* 다양한 키링 플러그인이 제공되지만 마스터 키를 관리하는 방법만 다를 뿐 MySQL 서버 내부적으로 작동하는 방식은 모두 동일하다.
  * keyring_file File-Based 플러그인(커뮤니티 에디션은 이것만 사용 가능)
  * keyring_encrypted_file Keyring 플러그인
  * keyring_okv KMIP 플러그인
  * keyring_aws Amazon Web Services Keyring 플러그인
* MySQL 서버의 키링 플러그인은 2단계 (2-Tier) 키 관리 방식을 사용한다.
* MySQL 서버에서는 두 가지 키로 암호화를 한다.
  * 마스터 키
  * 테이블 스페이스 키(프라이빗 키)

<img src="./그림 7.2.png">

* 암호화 아키텍처의 절차는 다음과 같다.
  * 1. 디스크의 파일(keyring_file, keyring_encrypted_file)에서 마스터 키를 가져온다.
  * 2. 암호화된 테이블이 생성될 때마다 해당 테이블을 위한 테이블 스페이스 키를 발급한다.
  * 3. 마스터 키를 이용해서 테이블 스페이스 키를 암호화해서 각 테이블의 데이터파일 헤더에 저장한다.(생성된 테이블 스페이스 키는 삭제되지 않는 이상 절대 변경 X)
* 마스터 키는 외부의 파일이기에 노출 가능성이 있어서 주기적으로 변경해야 한다.
```
mysql> ALTER INSTANCE ROTATE INNODB MASTER KEY; -- 마스터 키 변경 쿼리
```
* 마스터 키를 변경하면 MySQL 서버는 기존의 마스터 키를 이용해 각 테이블의 테이블 스페이스 키를 복호화한 다음 다시 새로운 마스터 키로 암호화하는데 이때 테이블 스페이스 키 자체와 데이터 파일의 데이터는 전혀 변경되지 않는다.
* 2단계 암호화를 사용하는 이유는 암호화 키 변경으로 인한 과도한 시스템 부하를 막기 위해서인데 테이블 스페이스 키가 변경된다면 데이터 파일의 모든 데이터를 다시 복호화 후 암호화 해야해서 엄청난 작업을 해야하며, 사용자 쿼리를 처리하는데도 영향을 미친다.
* MySQL 서버의 TDE에서 지원하는 암호화 알고리즘은 AES 256비트이며, 이외의 알고리즘은 지원되지 않는다.
  * 테이블 스페이스 키는 AES-256 ECB, 실제 파일은 AES-256 CBC 사용

### 7.1.2 암호화와 성능
* TDE 방식이므로 디스크로부터 한 번 읽은 데이터 페이지는 복호화되어 InnoDB의 버퍼 풀에 적재된다.
* 데이터 페이지가 한 번 메모리에 적재되면 암호화되지 않은 테이블과 동일한 성능을 보인다.
* InnoDB 버퍼 풀에 존재하지 않는 데이터 페이지를 읽어야 하는 경우, 복호화 과정을 거치므로 복호화 시간동안 지연된다.