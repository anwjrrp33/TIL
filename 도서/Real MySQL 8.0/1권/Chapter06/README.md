# 06 데이터 압축
MySQL 서버에서 디스크에 저장된 데이터 파일의 크기는 쿼리 처리 성능과 백업 및 복구 시간에 밀접하게 연결된다.<br>
데이터 파일이 크면 쿼리를 처리하기 위해 더 많은 데이터 페이지를 InnoDB 버퍼 풀에 읽어야 하고, 더티 페이지가 더 자주 디스크에 기록된다.<br>

데이터 파일이 크면 여러 문제가 발생된다.<br>
* 데이터 파일이 크면 쿼리를 처리하기 위해 더 많은 데이터 페이지를 InnoDB 버퍼 풀에 읽어야 한다.
* 더티 페이지가 더 자주 디스크에 기록된다.
* 백업 시간이 오래 걸리며, 복구하는 데도 시간이 걸린다.
* 저장 공간이 필요하기 때문에 비용 문제가 존재한다.

MySQL 서버에서 사용 가능한 압축 방식 크게 2가지이다.<br>
* 페이지 압축
* 테이블 압축

## 6.1 페이지 압축
페이지 압축은 `Transparent page compression`라고도 불린다.<br>
MySQL 서버가 디스크에 저장하는 시점에 데이터 페이지가 저장되고, 반대로 MySQL 서버가 디스크에서 데이터 페이지를 읽어올 때 압축이 해제된다.<br>
버퍼 풀에 데이터 페이지가 한 번 적재되면 InnoDB 스토리지 엔진은 압축이 해제된 상태로만 데이터 페이지를 관리한다.<br>
MySQL 서버의 내부 코드에서는 압축 여부와 관계없이 투명하게 작동한다.<br>
하나의 테이블은 동일한 크기의 페이지(블록)로 통일돼야 한다.<br>

* 펀치홀
    * 페이지 압축 기능은 운영체제별로 특정 버전의 파일 시스템에서만 지원되는 `펀치 홀(Punch hole)`이라는 기능 사용한다.
    * 예를들어 16KB 페이지를 압축하여 7KB가 되었고 이를 디스크에 저장하면 7KB만 기록하고 9KB는 빈 데이터를 기록하고, 그 후에 9KB에 대해 펀치홀을 생성하고 이를 운영체제로 반납한다.
    * 운영체제뿐만 아니라 하드웨어 자체에서도 해당 기능을 지원해야 사용 가능하며, 파일 시스템 관련 명령어가 펀치 홀을 지원하지 못한다.
        * 이런 이유로 페이지 압축은 많이 사용되지 않는 상태다.  

<img src="./그림 6.1.png">

* COMPRESSION 옵션 설정을 통한 페이지 압축 이용
```
-- // 테이블 생성 시
mysql> CREATE TABLE t1 (c1 INT) COMPRESSION="zlib";

-- // 테이블 변경 시
mysql> ALTER TABLE t1 COMPRESSION="zlib";
mysql> OPTIMIZE TABLE t1;
```

## 6.2 테이블 압축
* 운영체제나 하드웨어 대한 제약 없이 사용할 수 있기 때문에 일반적으로 활용도가 더 높은 편이다.
* 디스크의 데이터 파일 크기를 줄일 수 있기 때문에 그만큼의 이득은 있다.
* 테이블 압축도 몇 가지 단점이 있다.
    * 버퍼 풀 공간 활용률이 낮음
    * 쿼리 처리 성능이 낮음
    * 빈번한 데이터 변경 시 압축률이 떨어짐

### 6.2.1 압축 테이블 생성
* 테이블 압축을 사용하기 위한 전제 조건이 존재한다.
    * 압축을 사용하려는 테이블이 별도의 테이블 스페이스를 사용해야 한다.
    * `innodb_file_per_table` 시스템 변수가 ON 설정된 상태로 테이블이 생성돼야 한다.
    * `ROW_FORMAT=COMPRESSED` 옵션을 명시해야 한다.
    * `KEY_BLOCK_SIZE` 옵션을 명시할 때 2n(n 값은 2이상)으로 설정할 수 있다.
    * 페이지 크기가 16KB라면 KEY_BLOCK_SIZE는 4KB, 8KB만 가능하며, 페이지 크기가 32KB, 64KB면 테이블 압축을 적용할 수 없다.
```
mysql> SET GLOBAL innodb_file_per_table=ON;


```