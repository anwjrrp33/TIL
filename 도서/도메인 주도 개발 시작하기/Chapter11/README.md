# 11. CQRS

## 11.1 단일 모델의 단점
조회 화면 특성상 조회 속도가 빠를수도 좋은데 여러 애그리거트 데이터 필요하면 구현 방법을 고려해야 한다.<br>
애그리거트를 참조하는 방식을 사용하면 즉시 로딩과 같은 JPA의 쿼리 관련 최적화 기능을 사용할 수 없다.<br>

애그리거트 간의 연관을 ID가 아니라 직접 참조하는 방식으로 연결해도 고민거리가 생긴다.<br>
조회 화면 특성에 따라 즉시 로딩이나 지연 로딩으로 처리하거나 구현할 때 DBMS가 제공하는 전용 기능이 필요하면 JPA 네이티브 쿼리를 사용해야 할수도 있기 때문이다.<br>

이런 고민이 발생하는 이유는 시스템의 상태를 변경할 때와 조회할 때 단일 도메인 모델을 사용하기 때문이다.
ORM 기법은 상태 변경 기능에 적합하지만 상세 조회 화면처럼 여러 애그리거틀에서 데이터를 가져와 출력하는 기능을 구현하기에는 고려할게 많아서 구현을 복잡하게 만든다.<br>
구현 복잡도를 낮추기 위해 간단한 방법으로는 상태 변경을 위한 모델과 조회를 위한 모델을 분리하는 할 수 있다.<br>
[CQRS 아는척 하기 1](https://www.youtube.com/watch?v=xf0kXMTFJm8) 영상을 추천한다.<br>

## 11.2 CQRS
시스템은 크게 두 가지 기능을 제공한다.
* 상태를 변경하는 기능
* 사용자 입장에서 상태 정보를 조회하는 기능

도메인 모델 관점에서는 상태 변경 기능은 주로 한 애그리거트의 상태를 변경하고 조회 기능은 두 개 이상의 애그리거트가 필요할 때가 많다.<br>
상상태 변경 범위와 상태 조회 범위가 정확하게 일치하지 않기 때문에 단일 모델로 두 종류의 기능을 구현하면 모델이 불필요하게 복잡해진다.<br>
단일 모델을 사용할 때 발생하는 복잡도를 해결하기 위해 사용하는 방법이 바로 CQRS다.<br>
CQRS 는 Command Query Responsibility Segregation 의 약자로 상태를 변경하는 명령(Command)을 위한 모델과 상태를 제공하는 조회(Query)를 위한 모델을 분리하는 패턴이다.<br>


CQRS는 복잡한 도메인에 적합한데 통계에 CQRS를 적용해서 통계를 위한 조회 모델을 별도로 만들기 때문에 도메인 모델이 복잡해지는 것을 막을 수 있다.<br>
명령 모델은 JPA로 구현하고, 조회 모델은 마이바티스를 사용해서 구현해도 된다.<br>
<img src="./그림 11.2.png">


조회 모델에는 응용 서비스가 존재하지 않는데 단순히 데이터를 읽어와 조회하는 기능은 로직이 복하지 않기 때문에 바로 DAO를 실행해도 무방하다.<br>
표현 영역에 전달하는 과정에 몇 가지 로직이 필요하다면 응용 서비스를 두고 구현해도 된다.<br>
<img src="./그림 11.3.png">

상태 변경을 위한 명령 모델은 객체를 기반으로 한 도메인 모델을 이용해서 구현하고 상태를 변경하는 도메인 로직을 수행하는데 맞춰 설계한다.<br>
조회 모델은 필요한 정보를 담고 있는 데이터 타입을 이용해서 화면에 보여줄 데이터를 조회하는데 초첨을 맞춰 설계한다.<br>
<img src="./그림 11.4.png">

명령 모델과 조회 모델이 서로 다른 데이터 저장소를 사용할 수도 있다.<br>
* 명령 모델은 트랜잭션을 지원하는 RDBMS를 사용
* 조회 모델은 조회 성능이 좋은 NoSQL을 사용

두 데이터 저장소 간 데이터 동기화는 이벤트를 활용해서 처리한다.<br>
명령 모델에서 상태를 변경하면 이벤트가 발생하고 그 이벤트를 조회 모델에 전달해서 변경 내역을 반영하면 된다.<br>
두 모멜이 서로 다른 데이터 저장소를 사용할 경우 데이터 동기화 시점에 따라 구현 방식이 달라질 수도 있다.<br>
* 실시간 동기화는 동기 이벤트와 글로벌 트랜잭션 사용를 사용(전반적인 성능(응답 속도와 처리량)이 떨어지는 단점이 존재)
* 특정 시간 안에 동기화는 비동기 이벤트를 사용

<img src="./그림 11.5.png">

### 11.2.1 웹과 CQRS
일반적으로 웹 서비스는 상태 변경 요청보다 상태 조회 요청이 많다.<br>
포털이나 대형 쇼핑몰과 같이 조회 기능 요청 비율이 높은 서비스를 만드는 개발팀은 조회 성능을 높이기 위해 다양한 기법을 시도한다.<br>
* `쿼리 최적화`를 통한 실행 속도 자체를 높이기
* 메모리에 조회 데이터를 캐싱해서 `캐시 적용`을 통한 응답 속도를 높이기
* `조회 전용 저장소`를 따로 사용하기

조회 성능을 높이기 위해 다양한 기법을 사용하는 것은 결과적으로 CQRS를 적용하는 것과 같은 효과를 만든다.<br>
대규모 트래픽이 발생하는 웹 서비스는 알게 모르게 CQRS를 적용하게 된다.<br>
조회 성능을 높이기 우ㅐ허 별도 처리를 하고 있다면 명시적으로 명령 모델과 조회 모델을 구분해서 명령 모델이 복잡해지는 것을 막고 조회 기능에 특화된 구현 기법을 쉽게 적용할 수 있다.<br>

### 11.2.2 CQRS 장단점
* 장점
    * 명령 모델을 구현할 때 도메인 자체제 집중할 수 있다.
    * 명령 모델에서 조회 관련 로직이 사라져 복잡도가 낮아진다.
    * 조회 성능을 향상시키는데 유리하다.
        * 조회 단위로 캐시 기술을 적용할 수 있다.
        * 조회에 특화된 쿼리를 마음대로 사용할 수 있다.
        * 조회 전용 저장소를 사용하면 조회 처리량을 대폭 늘릴 수도 있다.
    * 조회 전용 모델을 사용하기 때문에 조회 성능을 높이기 위한 코드가 명령 모델에 영향을 주지 않는다.
* 단점
    * 구현해야 할 코드가 더 많아진다.
        * 단일 모델의 복잡함과 CQRS의 모델을 만들 때 발생하는 구현 비용을 따져봐야 한다.
        * 도메인이 복잡하거나 트래픽이 많다면 조회 전용 모델을 만드는것이 유지 보수에 유리하지만 트래픽이 많지 않은 경우 얻을 이점이 있는지 따져봐야한다.
    * 더 많은 구현 기술이 필요하다.
        * 명령 모델과 조회 모델을 다른 구현 기술을 사용하는 경우도 있고 서로 다른 저장소를 사용하기도 한다.
        * 데이터 동기화를 위해 메시징 시스템을 도입해야 할 수도 있다.

장단점을 고려해서 CQRS 패턴을 도입할지 여부를 결정해야 한다.
